<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Bitmap.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; </center>
<hr><h1>Bitmap.cpp</h1><a href="Bitmap_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 2003, Cornell University</span>
00004 <span class="comment">All rights reserved.</span>
00005 <span class="comment"></span>
00006 <span class="comment">Redistribution and use in source and binary forms, with or without</span>
00007 <span class="comment">modification, are permitted provided that the following conditions are met:</span>
00008 <span class="comment"></span>
00009 <span class="comment">    - Redistributions of source code must retain the above copyright notice,</span>
00010 <span class="comment">        this list of conditions and the following disclaimer.</span>
00011 <span class="comment">    - Redistributions in binary form must reproduce the above copyright</span>
00012 <span class="comment">        notice, this list of conditions and the following disclaimer in the</span>
00013 <span class="comment">        documentation and/or other materials provided with the distribution.</span>
00014 <span class="comment">    - Neither the name of Cornell University nor the names of its</span>
00015 <span class="comment">        contributors may be used to endorse or promote products derived from</span>
00016 <span class="comment">        this software without specific prior written permission.</span>
00017 <span class="comment"></span>
00018 <span class="comment">THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"</span>
00019 <span class="comment">AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00020 <span class="comment">IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00021 <span class="comment">ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span>
00022 <span class="comment">LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
00023 <span class="comment">CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
00024 <span class="comment">SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
00025 <span class="comment">INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
00026 <span class="comment">CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
00027 <span class="comment">ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF</span>
00028 <span class="comment">THE POSSIBILITY OF SUCH DAMAGE.</span>
00029 <span class="comment"></span>
00030 <span class="comment">*/</span>
00031 
00032 <span class="comment"></span>
00033 <span class="comment">/////////////////////////////////////////////////////////////////////</span>
00034 <span class="comment">///</span>
00035 <span class="comment">/// Bitmap.cpp</span>
00036 <span class="comment">///</span>
00037 <span class="comment">/////////////////////////////////////////////////////////////////////</span>
00038 <span class="comment"></span>
00039 <span class="preprocessor">#include "<a class="code" href="Bitmap_8h.html">Bitmap.h</a>"</span>
00040 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00041 <span class="preprocessor">#include &lt;limits.h&gt;</span>
00042 <span class="preprocessor">#include &lt;math.h&gt;</span>
00043 <span class="preprocessor">#include &lt;iostream&gt;</span>
00044 <span class="preprocessor">#include &lt;assert.h&gt;</span>
00045 <span class="comment"></span>
00046 <span class="comment">/////////////////////////////////////////////////////////////////////</span>
00047 <span class="comment">/// @addtogroup BitmapProcessing</span>
00048 <span class="comment"></span><span class="comment">/** @{ */</span>
00049 
<a name="l00050"></a><a class="code" href="Bitmap_8cpp.html#a0">00050</a> <span class="preprocessor">#define BYTE_COUNT (sizeof(unsigned int) / sizeof(unsigned char))</span>
00051 <span class="preprocessor"></span><span class="comment"></span>
00052 <span class="comment">/////////////////////////////////////////////////////////////////////</span>
00053 <span class="comment">/// Allocate the memory for the bitmap</span>
00054 <span class="comment">///</span>
00055 <span class="comment">/// @param numBits           number of bits in the Bitmap</span>
00056 <span class="comment">/////////////////////////////////////////////////////////////////////</span>
<a name="l00057"></a><a class="code" href="classBitmap.html#a11">00057</a> <span class="comment"></span><a class="code" href="group__BitmapProcessing.html#a11">Bitmap::Bitmap</a>(<span class="keywordtype">int</span> numBits) {
00058     <span class="comment">// Convert bitsize to number of ints</span>
00059     <a class="code" href="classBaseBitmap.html#Bitmapm3">_size</a> = (numBits / 32) + 1;
00060     <a class="code" href="classBitmap.html#Bitmapm0">_compSize</a> = (int)(<a class="code" href="classBaseBitmap.html#Bitmapm3">_size</a> * 1.25) + 1;
00061     <a class="code" href="classBaseBitmap.html#Bitmapm5">_memory</a> = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>[ <a class="code" href="classBaseBitmap.html#Bitmapm3">_size</a> ];
00062     <a class="code" href="classBitmap.html#Bitmapm2">_compMemory</a> = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>[<a class="code" href="classBitmap.html#Bitmapm0">_compSize</a> ];
00063     <a class="code" href="classBitmap.html#Bitmapm1">_compUsed</a> = 0;
00064     <a class="code" href="classBaseBitmap.html#Bitmapm4">_count</a> = 0;
00065 
00066     <span class="keywordtype">int</span> index;
00067 
00068     <span class="comment">// fill bitmap with zeroes</span>
00069     <span class="keywordflow">for</span> (index = 0; index &lt; <a class="code" href="classBaseBitmap.html#Bitmapm3">_size</a>; index++)
00070         <a class="code" href="classBaseBitmap.html#Bitmapm5">_memory</a>[index] = 0;
00071 
00072     <span class="comment">// fill compressed bitmap with zeroes</span>
00073     <span class="keywordflow">for</span> (index = 0; index &lt; <a class="code" href="classBitmap.html#Bitmapm0">_compSize</a>; index++)
00074         <a class="code" href="classBitmap.html#Bitmapm2">_compMemory</a>[index] = 0;
00075 }
00076 <span class="comment"></span>
00077 <span class="comment">/////////////////////////////////////////////////////////////////////</span>
00078 <span class="comment">/// Copy constructor</span>
00079 <span class="comment">///</span>
00080 <span class="comment">/// @param b                 bitmap to copy</span>
00081 <span class="comment">/////////////////////////////////////////////////////////////////////</span>
<a name="l00082"></a><a class="code" href="classBitmap.html#a12">00082</a> <span class="comment"></span><a class="code" href="group__BitmapProcessing.html#a11">Bitmap::Bitmap</a>(<a class="code" href="classBitmap.html">Bitmap</a> &amp;b): <a class="code" href="classBaseBitmap.html">BaseBitmap</a>(b) {
00083     <a class="code" href="classBaseBitmap.html#Bitmapm3">_size</a> = b._size;
00084     <a class="code" href="classBitmap.html#Bitmapm0">_compSize</a> = b._compSize;
00085     <a class="code" href="classBitmap.html#Bitmapm1">_compUsed</a> = b._compUsed;
00086     <a class="code" href="classBaseBitmap.html#Bitmapm5">_memory</a> = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>[ <a class="code" href="classBaseBitmap.html#Bitmapm3">_size</a> ];
00087     <a class="code" href="classBitmap.html#Bitmapm2">_compMemory</a> = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>[ <a class="code" href="classBitmap.html#Bitmapm0">_compSize</a> ];
00088     <a class="code" href="classBaseBitmap.html#Bitmapm4">_count</a> = b._count;
00089 
00090     <span class="keywordtype">int</span> index;
00091     <span class="keywordflow">for</span> ( index = 0; index &lt; b._size; index++)
00092         <a class="code" href="classBaseBitmap.html#Bitmapm5">_memory</a>[index] = b._memory[index];
00093 
00094     <span class="keywordflow">for</span> ( index = 0; index &lt; b._compSize; index++)
00095         <a class="code" href="classBitmap.html#Bitmapm2">_compMemory</a>[index] = b._compMemory[index];
00096 }
00097 
00098 <span class="comment"></span>
00099 <span class="comment">/////////////////////////////////////////////////////////////////////</span>
00100 <span class="comment">/// Deallocate memory for the Bitmap</span>
00101 <span class="comment">/////////////////////////////////////////////////////////////////////</span>
<a name="l00102"></a><a class="code" href="classBitmap.html#a13">00102</a> <span class="comment"></span><a class="code" href="group__BitmapProcessing.html#a13">Bitmap::~Bitmap</a>() {
00103     <span class="keyword">delete</span> [] <a class="code" href="classBitmap.html#Bitmapm2">_compMemory</a>;
00104 }
00105 <span class="comment"></span>
00106 <span class="comment">/////////////////////////////////////////////////////////////////////</span>
00107 <span class="comment">/// Fill in a 1 in a certain position in COMPRESSED data</span>
00108 <span class="comment">///</span>
00109 <span class="comment">/// @param j                 bit position in Bitmap to be changed</span>
00110 <span class="comment">/////////////////////////////////////////////////////////////////////</span>
<a name="l00111"></a><a class="code" href="classBitmap.html#a14">00111</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="group__BitmapProcessing.html#a14">Bitmap::FillCompEmptyPosition</a>(<span class="keywordtype">int</span> j) {
00112     <span class="comment">// Locate correct int in the bitmap</span>
00113     <span class="keywordtype">int</span> i = j / 32;
00114 
00115     <span class="comment">// switch on correct bit</span>
00116     <a class="code" href="classBitmap.html#Bitmapm2">_compMemory</a>[i] = <a class="code" href="classBitmap.html#Bitmapm2">_compMemory</a>[i] | BitTable[(j % 32)];
00117 }
00118 <span class="comment"></span>
00119 <span class="comment">/////////////////////////////////////////////////////////////////////</span>
00120 <span class="comment">/// Count the number of ones in the Compressed bitmap</span>
00121 <span class="comment">///</span>
00122 <span class="comment">/// @return the count of ones in the bitmap</span>
00123 <span class="comment">/////////////////////////////////////////////////////////////////////</span>
<a name="l00124"></a><a class="code" href="classBitmap.html#a15">00124</a> <span class="comment"></span><span class="keywordtype">int</span> <a class="code" href="group__BitmapProcessing.html#a15">Bitmap::SmallCount</a>(<span class="keywordtype">int</span> &amp;<a class="code" href="group__CounterVariables.html#a2">CountCounts</a>) {
00125     <span class="keywordtype">int</span> <span class="keyword">final</span> = 0;
00126     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *p;
00127     <a class="code" href="group__CounterVariables.html#a2">CountCounts</a>++;
00128 
00129     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classBitmap.html#Bitmapm1">_compUsed</a>; i++) {
00130         p = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) &amp; <a class="code" href="classBitmap.html#Bitmapm2">_compMemory</a>[i];
00131 
00132         <span class="comment">// count 1s by dividing into chars and using a lookup table</span>
00133         <span class="keyword">final</span> += CountTable[*p];
00134         p++;
00135         <span class="keyword">final</span> += CountTable[*p];
00136         p++;
00137         <span class="keyword">final</span> += CountTable[*p];
00138         p++;
00139         <span class="keyword">final</span> += CountTable[*p];
00140     }
00141 
00142     <span class="comment">// set the count for the bitmap</span>
00143     <a class="code" href="classBaseBitmap.html#Bitmapm4">_count</a> = <span class="keyword">final</span>;
00144     <span class="keywordflow">return</span> <span class="keyword">final</span>;
00145 }
00146 <span class="comment"></span>
00147 <span class="comment">/////////////////////////////////////////////////////////////////////</span>
00148 <span class="comment">/// Bitwise AND 2 compressed bitmaps and store the result</span>
00149 <span class="comment">///</span>
00150 <span class="comment">/// @param B1                first bitmap</span>
00151 <span class="comment">/// @param B2                second bitmap</span>
00152 <span class="comment">/// @param CountSmallAnds    [output] counter of ANDs on compressed data</span>
00153 <span class="comment">/////////////////////////////////////////////////////////////////////</span>
<a name="l00154"></a><a class="code" href="classBitmap.html#a16">00154</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="group__BitmapProcessing.html#a16">Bitmap::AndCompOnly</a>(
00155             <span class="keyword">const</span> <a class="code" href="classBitmap.html">Bitmap</a> &amp;B1,
00156             <span class="keyword">const</span> <a class="code" href="classBitmap.html">Bitmap</a> &amp;B2,
00157             <span class="keywordtype">int</span> &amp;<a class="code" href="group__CounterVariables.html#a4">CountSmallAnds</a>) {
00158             
00159     <a class="code" href="group__CounterVariables.html#a4">CountSmallAnds</a>++;
00160     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *b1ptr, *b2ptr;
00161 
00162     b1ptr = B1.<a class="code" href="classBitmap.html#Bitmapm2">_compMemory</a>;
00163     b2ptr = B2.<a class="code" href="classBitmap.html#Bitmapm2">_compMemory</a>;
00164     <a class="code" href="classBitmap.html#Bitmapm1">_compUsed</a> = B1.<a class="code" href="classBitmap.html#Bitmapm1">_compUsed</a>;
00165 
00166     <span class="comment">// AND the small bitmaps</span>
00167     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; B1.<a class="code" href="classBitmap.html#Bitmapm1">_compUsed</a>; i++) {
00168         <span class="comment">// and each INT bitwise</span>
00169         <a class="code" href="classBitmap.html#Bitmapm2">_compMemory</a>[i] = (*b1ptr) &amp; (*b2ptr);
00170 
00171         b1ptr++;
00172         b2ptr++;
00173     }
00174 }
00175 <span class="comment"></span>
00176 <span class="comment">/////////////////////////////////////////////////////////////////////</span>
00177 <span class="comment">/// Bitwise AND 2 compressed bitmaps and the negation and store the result</span>
00178 <span class="comment">///</span>
00179 <span class="comment">/// @param B1                first bitmap</span>
00180 <span class="comment">/// @param B2                second bitmap</span>
00181 <span class="comment">/// @param CountSmallAnds    [output] counter of ANDs on compressed data</span>
00182 <span class="comment">/////////////////////////////////////////////////////////////////////</span>
<a name="l00183"></a><a class="code" href="classBitmap.html#a17">00183</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="group__BitmapProcessing.html#a17">Bitmap::NotAndCompOnly</a>(
00184             <span class="keyword">const</span> <a class="code" href="classBitmap.html">Bitmap</a> &amp;B1,
00185             <span class="keyword">const</span> <a class="code" href="classBitmap.html">Bitmap</a> &amp;B2,
00186             <span class="keywordtype">int</span> &amp;<a class="code" href="group__CounterVariables.html#a4">CountSmallAnds</a>) {
00187             
00188     <a class="code" href="group__CounterVariables.html#a4">CountSmallAnds</a>++;
00189     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *b1ptr, *b2ptr;
00190 
00191     b1ptr = B1.<a class="code" href="classBitmap.html#Bitmapm2">_compMemory</a>;
00192     b2ptr = B2.<a class="code" href="classBitmap.html#Bitmapm2">_compMemory</a>;
00193     <a class="code" href="classBitmap.html#Bitmapm1">_compUsed</a> = B1.<a class="code" href="classBitmap.html#Bitmapm1">_compUsed</a>;
00194 
00195     <span class="comment">// AND the small bitmaps</span>
00196     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; B1.<a class="code" href="classBitmap.html#Bitmapm1">_compUsed</a>; i++) {
00197         <span class="comment">// and each INT bitwise</span>
00198         <a class="code" href="classBitmap.html#Bitmapm2">_compMemory</a>[i] = (*b1ptr) &amp; ~(*b2ptr);
00199 
00200         b1ptr++;
00201         b2ptr++;
00202     }
00203 }
00204 <span class="comment"></span>
00205 <span class="comment">/////////////////////////////////////////////////////////////////////</span>
00206 <span class="comment">/// Compress this bitmap relative to the source - has a bit for each</span>
00207 <span class="comment">///    trans in source</span>
00208 <span class="comment">///</span>
00209 <span class="comment">/// @param source            the bitmap you are compressing relative to</span>
00210 <span class="comment">/////////////////////////////////////////////////////////////////////</span>
<a name="l00211"></a><a class="code" href="classBitmap.html#a18">00211</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="group__BitmapProcessing.html#a18">Bitmap::BuildRelComp</a>(<a class="code" href="classBitmap.html">Bitmap</a> &amp;source) {
00212     <span class="keywordtype">int</span> i;
00213     <span class="keywordtype">int</span> bc;
00214 
00215     <span class="comment">// index into current int (how much of current int has been filled)</span>
00216     <span class="keywordtype">int</span> d = 0;  
00217 
00218     <span class="comment">// zero your compressed contents</span>
00219     <a class="code" href="classBitmap.html#Bitmapm1">_compUsed</a> = source.<a class="code" href="classBitmap.html#Bitmapm1">_compUsed</a>;
00220     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="classBitmap.html#Bitmapm1">_compUsed</a>; i++)
00221         <a class="code" href="classBitmap.html#Bitmapm2">_compMemory</a>[i] = 0;
00222 
00223     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *result = <a class="code" href="classBitmap.html#Bitmapm2">_compMemory</a>;
00224     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tempResult;
00225     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *p_s, *p_t;
00226 
00227     p_s = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) source.<a class="code" href="classBaseBitmap.html#Bitmapm5">_memory</a>;
00228     p_t = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) <a class="code" href="classBaseBitmap.html#Bitmapm5">_memory</a>;
00229 
00230     <span class="comment">// for each byte of the ORIGINAL bitmaps</span>
00231     <span class="keywordflow">for</span> (i = 0; i &lt; (<a class="code" href="classBaseBitmap.html#Bitmapm3">_size</a> * 4); i++) {
00232         <span class="comment">// find out how many bits needed to represent this byte</span>
00233         <span class="comment">//     in compressed form</span>
00234         <span class="comment">// (# of 1's in the ORIGINAL data of the SOURCE)</span>
00235         bc = CountTable[(*p_s)];
00236 
00237         <span class="comment">// if there is anything when byte compressed</span>
00238         <span class="keywordflow">if</span> (bc &gt; 0) {
00239             <span class="comment">// check if enough space in current int of COMPRESSED data</span>
00240             <span class="comment">//     for the compressed byte result</span>
00241             <span class="keywordflow">if</span> ((32 - d) &gt;= bc) {
00242                 <span class="comment">// compress and append compressed result for this byte to</span>
00243                 <span class="comment">//     rest of compressed data</span>
00244                 tempResult = CompTable[(*p_s)][(*p_t)] &gt;&gt; d;
00245                 *result = (*result) | tempResult;
00246                 d += bc;
00247             } <span class="keywordflow">else</span> {
00248                 <span class="comment">// go to the next int in compressed data, compress and</span>
00249                 <span class="comment">//     append compressed result there</span>
00250                 result++;
00251                 tempResult = CompTable[(*p_s)][(*p_t)];
00252                 *result = (*result) | tempResult;
00253                 d = bc;
00254             }
00255 
00256         }
00257         
00258         <span class="comment">// go to the byte in the ORIGINAL bitmaps</span>
00259         p_s++;
00260         p_t++;
00261     }
00262 }
00263 <span class="comment"></span>
00264 <span class="comment">/////////////////////////////////////////////////////////////////////</span>
00265 <span class="comment">/// Fill the compressed bitmap with ones</span>
00266 <span class="comment">/////////////////////////////////////////////////////////////////////</span>
<a name="l00267"></a><a class="code" href="classBitmap.html#a19">00267</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="group__BitmapProcessing.html#a19">Bitmap::BuildSource</a>() {
00268     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *whatever = <a class="code" href="classBitmap.html#Bitmapm2">_compMemory</a>;
00269 
00270     <span class="comment">// find out how many INTs will be used in the compressed data</span>
00271     <span class="keywordtype">int</span> scaledSup = (int)ceil( ((<span class="keywordtype">float</span>)<a class="code" href="classBaseBitmap.html#Bitmapm4">_count</a> * 1.25) / (<span class="keywordtype">float</span>)32 );
00272     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; scaledSup; i++) {
00273         <span class="comment">// fill the int with all ones</span>
00274         (*whatever) = UINT_MAX;
00275         whatever++;
00276     }
00277 
00278     <a class="code" href="classBitmap.html#Bitmapm1">_compUsed</a> = scaledSup;
00279 }
00280 <span class="comment"></span>
00281 <span class="comment">/** @} */</span>
</pre></div><hr><address style="align: right;"><small>Generated on Thu Dec 4 15:22:06 2003 for MAFIA by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
